
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyantarctica.dataset &#8212; The pyantarctica package</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyantarctica.dataset</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2017-2018 - Swiss Data Science Center (SDSC)</span>
<span class="c1"># A partnership between École Polytechnique Fédérale de Lausanne (EPFL) and</span>
<span class="c1"># Eidgenössische Technische Hochschule Zürich (ETHZ).</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="parsetime"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.parsetime">[docs]</a><span class="k">def</span> <span class="nf">parsetime</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to format timestamps to HH:MM:SS</span>

<span class="sd">        :param x: string containing badly formatted timestams</span>
<span class="sd">        :returns: nicely formatted timestamp string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">zeropad_date</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper to left-pad with 0s the timestamp</span>

<span class="sd">            :params x: timestamp string to be zeropadded, if len(x)&lt;2</span>
<span class="sd">            :returns: left - 0 padded string of length 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">toadd</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">toadd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">zeropad_date</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">zeropad_date</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">zeropad_date</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">t_str</span> <span class="o">=</span>  <span class="n">h</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">s</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">zeropad_date</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">zeropad_date</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">h</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="s1">&#39;:00&#39;</span>

    <span class="n">t_str</span> <span class="o">+=</span> <span class="n">toadd</span>

    <span class="k">return</span> <span class="n">t_str</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="add_datetime_index_from_column"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.add_datetime_index_from_column">[docs]</a><span class="k">def</span> <span class="nf">add_datetime_index_from_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">old_column_name</span><span class="p">,</span> <span class="n">string_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%Y %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;timest_&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a column in a dataframe df to a datetime element and move it as index of the df. The string_format rule specifies how the raw string is formatted.</span>

<span class="sd">        :param df: dataframe of the original data</span>
<span class="sd">        :param old_column_name: column containing the raw datetime string to be converted</span>
<span class="sd">        :param string_format: how the string is organized</span>
<span class="sd">        :param index_name: new column to add with datetime, and moved as index</span>
<span class="sd">        :returns: dataframe with datetime index named index_name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">tzinfo</span><span class="p">,</span> <span class="n">timedelta</span>
    <span class="kn">from</span> <span class="nn">calendar</span> <span class="k">import</span> <span class="n">timegm</span>

    <span class="k">class</span> <span class="nc">UTC</span><span class="p">(</span><span class="n">tzinfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;UTC subclass&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;UTC&quot;</span>
        <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">datetime_object</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">string_format</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">old_column_name</span><span class="p">]]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">old_column_name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">datetime_obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">date_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">UTC</span><span class="p">())</span> <span class="k">for</span> <span class="n">date_</span> <span class="ow">in</span> <span class="n">datetime_object</span><span class="p">]</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="p">[</span><span class="n">timegm</span><span class="p">(</span><span class="n">date_</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span> <span class="k">for</span> <span class="n">date_</span> <span class="ow">in</span> <span class="n">datetime_obj</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">index_name</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">index_name</span><span class="p">]),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">index_name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="add_legs_index"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.add_legs_index">[docs]</a><span class="k">def</span> <span class="nf">add_legs_index</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a leg identifier (defaults to [1,2,3]) to a datetime indexed dataframe of ACE measurements</span>

<span class="sd">        :param df: datetime indexed dataframe to which add the leg index</span>
<span class="sd">        :param kwargs: contains options to override defaults:</span>

<span class="sd">        |   leg_dates : array indicating beginning and end (columns) of time period belonging to a leg / subleg (number of rows equals number of legs / sublegs)</span>
<span class="sd">        |   codes : list indicating what code to use to denote legs. Defaults to integers in range [1,2,3,...] with 0 indicating out-of-leg datapoints</span>

<span class="sd">        :returns: dataframe with a new column &quot;leg&quot; indicating to which leg the datapoint belongs to</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;leg_dates&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">leg_dates</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;2016-12-20&#39;</span><span class="p">,</span> <span class="s1">&#39;2017-01-21&#39;</span><span class="p">],</span> <span class="c1"># leg 1</span>
                    <span class="p">[</span><span class="s1">&#39;2017-01-22&#39;</span><span class="p">,</span> <span class="s1">&#39;2017-02-25&#39;</span><span class="p">],</span>  <span class="c1"># leg 2</span>
                    <span class="p">[</span><span class="s1">&#39;2017-02-26&#39;</span><span class="p">,</span> <span class="s1">&#39;2017-03-19&#39;</span><span class="p">]]</span>  <span class="c1"># leg 3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leg_dates</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;leg_dates&#39;</span><span class="p">]</span>


    <span class="c1"># merz_glacier = [&#39;2017-01-29&#39;, &#39;2017-01-31&#39;]</span>

    <span class="k">if</span> <span class="s1">&#39;codes&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">leg_dates</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;codes&#39;</span><span class="p">]</span>

    <span class="sd">&quot;&quot;&quot;Add a column to the datatable specifying the cruise leg&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">leg_dates</span><span class="p">),</span> <span class="s2">&quot;To each date interval must correspond only one code&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;leg&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;leg column already there&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">dd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;leg&#39;</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">):</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">leg_dates</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">leg_dates</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">codes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="s1">&#39;merz_glacier&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merz_glacier</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">merz_glacier</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># dd.loc[dd[&#39;leg&#39;].isnull()] = 0</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">leg</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="ts_aggregate_timebins"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.ts_aggregate_timebins">[docs]</a><span class="k">def</span> <span class="nf">ts_aggregate_timebins</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">time_bin</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="n">index_position</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outer merge of two datatables based on a common resampling of time intervals:</span>

<span class="sd">        :param df1: datetime indexed dataframe to resample</span>
<span class="sd">        :param time_bin: aggregation time, in minutes</span>
<span class="sd">        :param operations: dictionary containing a suffix to add to the column name (empty to keep same name in the returned df) and operation used to aggregate entries in the df. Example {&#39;_min&#39;: np.nanmin, &#39;_max&#39;:np.nanmax} returns a dataframe with columns &#39;%colname_min&#39; and &#39;%colname_max&#39;, where %colname is the original column name.</span>
<span class="sd">        :param index_position: position of the new timestamp index wrt to the resampling : &#39;initial&#39;, &#39;middle&#39; or &#39;final&#39;</span>
<span class="sd">        :returns: resampled dataframe with uninterrupted datetime index and NaNs where needed</span>
<span class="sd">        :Example:</span>

<span class="sd">            operations = {&#39;_min&#39;: np.min , &#39;_mean&#39;: np.mean, &#39;_max&#39;: np.max, &#39;_sum&#39;: np.sum}</span>
<span class="sd">            df_res = dataset.ts_aggregate_timebins(df1, 15, operations, index_position=&#39;initial&#39;)</span>
<span class="sd">            print(df_res.head())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_bin</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;T&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">:]:</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">operations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="o">+</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">res_</span><span class="p">))</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">nanind</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">res_</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="n">df1</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">res_</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">res_</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="o">+</span><span class="n">op</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nanind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">index_position</span> <span class="o">==</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">index_position</span> <span class="o">==</span> <span class="s1">&#39;middle&#39;</span><span class="p">:</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">time_bin</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span> <span class="c1"># From minutes to seconds, to round up to the second.</span>
    <span class="k">elif</span> <span class="n">index_position</span> <span class="o">==</span> <span class="s1">&#39;final&#39;</span><span class="p">:</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">time_bin</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>

    <span class="c1"># print(time_ shift)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">time_shift</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="filter_particle_sizes"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.filter_particle_sizes">[docs]</a><span class="k">def</span> <span class="nf">filter_particle_sizes</span><span class="p">(</span><span class="n">pSize</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to filter particle size distribution dataframes, where rows are datetime index entries and columns are subsequent, as given by the instrument, particle size bins.</span>

<span class="sd">        :param pSize: datetime indexed dataframe of all particles. I think should be in dN/dlogD</span>
<span class="sd">        :param threshold: check for a multiplicative increase, given by expected_value * threshold</span>
<span class="sd">        :param window: size of the square moving windows to retrieve statistics, see ret_neigh()</span>
<span class="sd">        :param mode: string specifying how to compute value to threholds: &#39;mean&#39;: the expected value is the mean of the values in the window. &#39;std&#39; returns the standard deviation and &#39;any&#39; all the values (to implement original filtering method)</span>
<span class="sd">        :param save: if string is presented, save csv at this pointer</span>
<span class="sd">        :returns: filtered particle dataframe, with same datetime index as pSize</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">ret_neigh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            helper with different hardcoded scanning windows. returns a list of indexes based on the centerpoint of the window.</span>

<span class="sd">            .. todo:: automatize the window creation. This was a quick and dirt thing to see if it was working</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fil_</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fil_</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>             <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>           <span class="p">[</span><span class="n">i</span><span class="p">,</span>  <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fil_</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>           <span class="p">[</span><span class="n">i</span><span class="p">,</span>  <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">fil_</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>          <span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span>   <span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">fil_</span>


    <span class="k">def</span> <span class="nf">ret_values</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            helper returning all the values in the data matrix contained in every window, as rows. it returns a matrix with size data.shape[0]*data.shape[1], and number of columns eequal to the number of elements in the scanning windows. Note that the center valie is returned at the first row, row=0.</span>
<span class="sd">            .. todo:: make the inner loop faster by using actual index sampling, the clever way</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">window</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">d_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symmetric&#39;</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">d_pad</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">d_pad</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">fil_</span> <span class="o">=</span> <span class="n">ret_neigh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">window</span><span class="p">)</span>
                <span class="n">em</span><span class="p">[</span><span class="n">col</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_pad</span><span class="p">[</span><span class="n">fil_</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">fil_</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
                <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">em</span>

    <span class="n">part_size</span> <span class="o">=</span> <span class="n">pSize</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vect_filt</span> <span class="o">=</span> <span class="n">ret_values</span><span class="p">(</span><span class="n">part_size</span><span class="p">)</span>

    <span class="c1"># print(mea)</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">mea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vect_filt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">local_t</span>  <span class="o">=</span> <span class="n">vect_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">*</span> <span class="n">mea</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;std&#39;</span><span class="p">:</span>
        <span class="n">mea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vect_filt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">vect_filt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">local_t</span> <span class="o">=</span> <span class="n">vect_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mea</span> <span class="o">+</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">sig</span><span class="p">)</span>
        <span class="n">local_t</span> <span class="o">=</span> <span class="n">local_t</span><span class="o">|</span><span class="p">(</span><span class="n">vect_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mea</span> <span class="o">-</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">sig</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;any&#39;</span><span class="p">:</span>
        <span class="n">local_t</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">vect_filt</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">vect_filt</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vect_filt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">local_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_t</span><span class="p">)</span>

    <span class="n">loca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">local_t</span><span class="p">,</span> <span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">part_size</span><span class="p">[</span><span class="n">loca</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Delete lines which are alone (e.g. nans above and nans below)</span>
    <span class="n">global_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">line_above_na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">part_size</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span> <span class="o">&gt;</span> <span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.50</span>
        <span class="n">line_above_ze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">part_size</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.50</span>
        <span class="n">line_above</span> <span class="o">=</span> <span class="n">line_above_na</span> <span class="o">|</span> <span class="n">line_above_ze</span>

        <span class="n">line_below_na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">part_size</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]))</span> <span class="o">&gt;</span> <span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.50</span>
        <span class="n">line_below_ze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">part_size</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">part_size</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.50</span>
        <span class="n">line_below</span> <span class="o">=</span> <span class="n">line_below_na</span> <span class="o">|</span> <span class="n">line_below_ze</span>

        <span class="n">global_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line_above</span> <span class="o">&amp;</span> <span class="n">line_below</span><span class="p">)</span>
        <span class="c1"># global_t[i] = global_t[i] | (np.sum(np.isnan(part_size[i,:])) &gt; part_size.shape[1]*0.50)</span>
        <span class="n">global_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">part_size</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>

    <span class="n">part_size</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">global_t</span><span class="p">)[</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">string_</span> <span class="o">=</span> <span class="s1">&#39;local_t : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">local_t</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span> <span class="o">+</span> <span class="s1">&#39;global_t : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">global_t</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">string_</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">part_size</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">pSize</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">pSize</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="generate_particle_data"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.generate_particle_data">[docs]</a><span class="k">def</span> <span class="nf">generate_particle_data</span><span class="p">(</span><span class="n">data_folder</span><span class="o">=</span><span class="s1">&#39;../data/&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">data_output</span><span class="o">=</span><span class="s1">&#39;./data/intermediate/&#39;</span><span class="p">,</span>
                           <span class="n">savedata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filtering_parameter</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Utility to get aggregated aerosol data and store it in a df where columns are the different accregation. This function recomputes directly from locally stored filtered particle size data the aggregations. This function assumes that the folder structures are fixed.</span>


<span class="sd">        :param data_folder: pointer to data top directory</span>
<span class="sd">        :param data_output: where to save aggregated dataframe</span>
<span class="sd">        :param mode: what to read and how:</span>

<span class="sd">        | &#39;all&#39; : all particle data in columns (small particles single bins and &gt;400, &gt;700 nm)</span>
<span class="sd">        | &#39;single_bins&#39; : only single bin data (without accumulated &gt;400 and &gt; 700nm)</span>
<span class="sd">        | &#39;aggregated&#39;: all particle data aggregated in superbins (with &gt;400,&gt;700 nm)</span>
<span class="sd">        | &#39;aggregated_no_noise&#39; : as &#39;aggregated&#39; but without noisy bins</span>

<span class="sd">        :param filtering_parameter: used to define which filtered data to read (see filter_particle_size   threshold): 3, 5, 10 : the larger, the more permissive</span>
<span class="sd">        :param savedata: boolean, store locally (in ./data/intermediate/) a copy of the assembled file</span>
<span class="sd">        :returns: datetime-indexed dataframe with particle sizes as columns</span>

<span class="sd">        .. todo:: remove data folder structure assumption. Or actually rethink the whole function.</span>
<span class="sd">        .. todo:: actually maybe better to deprecate the whole function and prepare a notebook preparing the data directly, maybe easier for renku inclusion. Even better, a big script preparing the different datsets.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">particles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_folder</span> <span class="o">+</span> <span class="s1">&#39;intermediate/7_aerosols/03_filtered_particle_size_distribution_T&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">filtering_parameter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timest_&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="c1">#print(particles.index)</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;single_bins&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">savedata</span><span class="p">:</span>
            <span class="n">particles</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">aggregated_no_noise</span> <span class="o">+</span> <span class="s1">&#39;/03_particles_&#39;</span> <span class="o">+</span> <span class="n">mode</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">particles</span>

    <span class="n">aero_l700</span> <span class="o">=</span> <span class="n">read_standard_dataframe</span><span class="p">(</span><span class="n">data_folder</span> <span class="o">+</span> <span class="s1">&#39;intermediate/7_aerosols/12_Aerosol_larger_700nm_postprocessed.csv&#39;</span><span class="p">)</span>
    <span class="n">aero_l400</span> <span class="o">=</span> <span class="n">read_standard_dataframe</span><span class="p">(</span><span class="n">data_folder</span> <span class="o">+</span>  <span class="s1">&#39;intermediate/7_aerosols/13_Aerosol_larger_400nm_postprocessed.csv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">aero_l400</span><span class="p">)</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;400&#39;</span><span class="p">})</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">aero_l700</span><span class="p">)</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;700&#39;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">savedata</span><span class="p">:</span>
            <span class="n">particles</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_output</span> <span class="o">+</span> <span class="s1">&#39;/00_particles_&#39;</span> <span class="o">+</span> <span class="n">mode</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">particles</span>

    <span class="n">part_legend</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">data_folder</span> <span class="o">+</span> <span class="s1">&#39;raw/7_aerosols/04_diameterforfile_03.txt&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;aggregated&#39;</span><span class="p">:</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">part_legend</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&lt;=</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;11-80&#39;</span><span class="p">})</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;11-80&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cond</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&gt;</span><span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;80-200&#39;</span><span class="p">})</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;80-200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cond</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&gt;</span><span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span> <span class="o">&lt;=</span> <span class="mi">400</span><span class="p">)</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;200-400&#39;</span><span class="p">})</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;200-400&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cond</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;&gt;400&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aero_l400</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;&gt;700&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aero_l700</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;aggregated_no_noise&#39;</span><span class="p">:</span>

        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="p">((</span><span class="n">part_legend</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&lt;</span><span class="mi">35</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">part_legend</span><span class="o">&gt;</span><span class="mi">51</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&lt;=</span><span class="mi">80</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;11-80&#39;</span><span class="p">})</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;11-80&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cond</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&gt;</span><span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;80-200&#39;</span><span class="p">})</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;80-200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cond</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">part_legend</span><span class="o">&gt;</span><span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">part_legend</span> <span class="o">&lt;=</span> <span class="mi">300</span><span class="p">)</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">newcol</span><span class="o">=</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">part_agg</span> <span class="o">=</span> <span class="n">part_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newcol&#39;</span><span class="p">:</span> <span class="s1">&#39;200-300&#39;</span><span class="p">})</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;200-300&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">cond</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;&gt;400&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aero_l400</span>
        <span class="n">part_agg</span><span class="p">[</span><span class="s1">&#39;&gt;700&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aero_l700</span>

    <span class="k">if</span> <span class="n">savedata</span><span class="p">:</span>
        <span class="n">part_agg</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_output</span> <span class="o">+</span> <span class="s1">&#39;/00_particles_&#39;</span> <span class="o">+</span> <span class="n">mode</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">part_agg</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="read_standard_dataframe"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.read_standard_dataframe">[docs]</a><span class="k">def</span> <span class="nf">read_standard_dataframe</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">datetime_index_name</span><span class="o">=</span><span class="s1">&#39;timest_&#39;</span><span class="p">,</span> <span class="n">crop_legs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function to read a ``*_postprocessed.csv`` file, and automatically crop out leg 1 - leg 3, and set as datetime index a specific column (or defaults to the standard)</span>

<span class="sd">        :param data_folder: from where to read the ``*_postprocessed.csv`` datafile</span>
<span class="sd">        :param datetime_index_name: specify non-default datetime index column (= ``timest_``)</span>
<span class="sd">        :param crop_legs: boolean to specify whether to remove data outside leg 1 to leg 3</span>
<span class="sd">        :returns: dataframe containing the original data, leg-cropped (if option active)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">datetime_index_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crop_legs</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">add_legs_index</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;leg&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;leg&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="subset_data_stack_variables"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.subset_data_stack_variables">[docs]</a><span class="k">def</span> <span class="nf">subset_data_stack_variables</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">varset</span><span class="p">,</span> <span class="n">seatype</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;subset&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Subset variables of a dataset stack. This function is just a shorthand to not have to specify all vaiables when subsetting dataframes. Not the most clever way to deal with this honestly.</span>

<span class="sd">        :param data: dataframe of data to subset</span>
<span class="sd">        :param varset: keyword specifiying the subset to get</span>
<span class="sd">        :param seatype: defaults to total. When &quot;wave&quot; parameters are to be retrieved, specify which kind of sea parameters to have</span>
<span class="sd">        :param mode: subset : return actual dataframe or returnnames: return only column names per subset</span>
<span class="sd">        :returns: either dataframe of data, or list of columns names.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wave&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;waves&#39;</span><span class="p">):</span>
        <span class="n">cols_total</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;steep&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]</span>
        <span class="n">cols_wind</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs_w&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_w&#39;</span><span class="p">,</span> <span class="s1">&#39;steep_w&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_vel_w&#39;</span><span class="p">,</span> <span class="s1">&#39;age_w&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wave_nowind&#39;</span><span class="p">:</span>
        <span class="n">cols_total</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;steep&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_vel&#39;</span><span class="p">]</span>
        <span class="n">cols_wind</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs_w&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_w&#39;</span><span class="p">,</span> <span class="s1">&#39;steep_w&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_vel_w&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wave_reduced&#39;</span><span class="p">:</span>
        <span class="n">cols_total</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]</span>
        <span class="n">cols_wind</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs_w&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_w&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wave_ecmwf&#39;</span><span class="p">:</span>
        <span class="n">cols_total</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;steep&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">,</span>
         <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;slp&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;iwc&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">,</span> <span class="s1">&#39;th&#39;</span><span class="p">,</span> <span class="s1">&#39;lsp&#39;</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span>
         <span class="s1">&#39;rtot&#39;</span><span class="p">,</span> <span class="s1">&#39;blh&#39;</span><span class="p">,</span> <span class="s1">&#39;blhp&#39;</span><span class="p">,</span> <span class="s1">&#39;td2m&#39;</span><span class="p">,</span> <span class="s1">&#39;t2m&#39;</span><span class="p">,</span> <span class="s1">&#39;skt&#39;</span><span class="p">,</span> <span class="s1">&#39;sif&#39;</span><span class="p">,</span> <span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;lsm&#39;</span><span class="p">]</span>
        <span class="n">cols_wind</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hs_w&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_w&#39;</span><span class="p">,</span> <span class="s1">&#39;steep_w&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_vel_w&#39;</span><span class="p">,</span> <span class="s1">&#39;age_w&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;slp&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;iwc&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">,</span> <span class="s1">&#39;th&#39;</span><span class="p">,</span> <span class="s1">&#39;lsp&#39;</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;rtot&#39;</span><span class="p">,</span> <span class="s1">&#39;blh&#39;</span><span class="p">,</span> <span class="s1">&#39;blhp&#39;</span><span class="p">,</span> <span class="s1">&#39;td2m&#39;</span><span class="p">,</span> <span class="s1">&#39;t2m&#39;</span><span class="p">,</span> <span class="s1">&#39;skt&#39;</span><span class="p">,</span> <span class="s1">&#39;sif&#39;</span><span class="p">,</span> <span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;lsm&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ecmwf&#39;</span><span class="p">:</span>
        <span class="n">cols_total</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;slp&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;iwc&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">,</span> <span class="s1">&#39;th&#39;</span><span class="p">,</span> <span class="s1">&#39;lsp&#39;</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rtot&#39;</span><span class="p">,</span> <span class="s1">&#39;blh&#39;</span><span class="p">,</span> <span class="s1">&#39;blhp&#39;</span><span class="p">,</span> <span class="s1">&#39;td2m&#39;</span><span class="p">,</span> <span class="s1">&#39;t2m&#39;</span><span class="p">,</span> <span class="s1">&#39;skt&#39;</span><span class="p">,</span> <span class="s1">&#39;sif&#39;</span><span class="p">,</span> <span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;lsm&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">varset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wholeset&#39;</span><span class="p">:</span>
        <span class="n">cols_total</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;variables not specified&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">seatype</span> <span class="o">==</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">cols_total</span>
    <span class="k">elif</span> <span class="n">seatype</span> <span class="o">==</span> <span class="s1">&#39;wind&#39;</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">cols_wind</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;seatype not correct&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;subset&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;parbin&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;parbin&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;returnnames&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cols</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="retrieve_correlation_to_particles"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.retrieve_correlation_to_particles">[docs]</a><span class="k">def</span> <span class="nf">retrieve_correlation_to_particles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">legs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieve correlation to the whole series, and, if legs are specified, to independend legs.</span>

<span class="sd">        :param data: dataframe of data, from which a column will be picked (var) and used to compute correlations to particle data</span>
<span class="sd">        :param particles: dataframe containing different particle sizes bins, to which compute correlation with data</span>
<span class="sd">        :param var: string indicating name of the data column to use</span>
<span class="sd">        :param legs: IDs of the legs in which you want to computer correlations</span>
<span class="sd">        :param plots: If True, plot the barplots indicating amount of correlations</span>
<span class="sd">        :returns: dictionary containing correlations to particles, figure (no handles returned, get them via plt.gca, plt.gcf and so on)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;leg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">add_legs_index</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;leg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">particles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">add_legs_index</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>

    <span class="n">corrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">N</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">legs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">legs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">particles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">p_leg</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">particles</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;leg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span><span class="n">col</span><span class="p">]</span>
                <span class="n">va_leg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;leg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="n">var</span><span class="p">]</span>
                <span class="n">corrs</span><span class="p">[</span><span class="s1">&#39;corr_&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">leg</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_leg</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">va_leg</span><span class="p">)</span>
                <span class="c1"># N[col + &#39;_&#39; + str(leg)] =</span>
                <span class="n">N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_leg</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">va_leg</span><span class="o">.</span><span class="n">notnull</span><span class="p">()))</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">particles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

        <span class="n">p_leg</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">particles</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;leg&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">,</span><span class="n">col</span><span class="p">]</span>
        <span class="n">va_leg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;leg&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="p">]</span>
        <span class="n">corrs</span><span class="p">[</span><span class="s1">&#39;corr_&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_leg</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">va_leg</span><span class="p">)</span>
        <span class="c1">#N[col + &#39;_&#39; + &#39;total&#39;] =</span>
        <span class="n">N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_leg</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">va_leg</span><span class="o">.</span><span class="n">notnull</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">legs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;still need to adapt to single series correlation, quick fix!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">corrs</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">corrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>

        <span class="n">bar_w</span> <span class="o">=</span> <span class="mf">0.16</span>
        <span class="n">f</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">legend</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;leg 1&#39;</span><span class="p">,</span> <span class="s1">&#39;leg 2&#39;</span><span class="p">,</span> <span class="s1">&#39;leg 3&#39;</span><span class="p">,</span> <span class="s1">&#39;whole series&#39;</span><span class="p">]</span>
        <span class="n">in_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">ra</span><span class="p">:</span>
            <span class="n">end_</span> <span class="o">=</span> <span class="n">in_</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">corrs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">in_</span><span class="p">:</span><span class="n">end_</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">group</span><span class="o">*</span><span class="n">bar_w</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">bar_w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>
            <span class="n">in_</span> <span class="o">=</span> <span class="n">end_</span>

        <span class="n">bars</span> <span class="o">=</span> <span class="p">[</span><span class="n">rect</span> <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
            <span class="c1"># print(b,N[b],N)</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">N</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">N</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Correlations of &#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39; to particle groups&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">bar_w</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corrs</span></div>

<span class="c1">##############################################################################################################</span>
<div class="viewcode-block" id="read_traj_file_to_numpy"><a class="viewcode-back" href="../../dataset.html#pyantarctica.dataset.read_traj_file_to_numpy">[docs]</a><span class="k">def</span> <span class="nf">read_traj_file_to_numpy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ntime</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read air mass trajectory files as provided in project 11 -- read them from trajetories/lsl folder</span>

<span class="sd">        :param filename: file to be parsed</span>
<span class="sd">        :param ntime: numer of backtracking time points (i.e. how many rows per trajectory to read)</span>
<span class="sd">        :returns: traj_ensemble, a datacube containing N_trajectories x M_backtracking_time_intervals x D_variables_model_out</span>
<span class="sd">        :returns: columns : name of D_variables_model_out (variables provided by the lagranto model)</span>
<span class="sd">        :returns: starttime : beggining of the backtracking time series in the ensemble</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fname</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">fname</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">starttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M&#39;</span><span class="p">)</span>

    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f8&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
    <span class="n">dtypes</span><span class="p">[</span><span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;datetime64[s]&#39;</span>

    <span class="n">convertfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)})</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                  <span class="n">missing_values</span><span class="o">=</span><span class="s1">&#39;-999.99&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">,</span>
                  <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">convertfunc</span><span class="p">},</span> <span class="n">usemask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ntra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">ntime</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">array</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="c1"># timestep, period = (array[&#39;time&#39;][1] - array[&#39;time&#39;][0], array[&#39;time&#39;][-1] - array[&#39;time&#39;][0])</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ntra</span><span class="p">,</span> <span class="n">ntime</span><span class="p">))</span>

    <span class="n">traj_ensemble</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">56</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">81</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">array</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">it</span><span class="p">]]</span>
    <span class="n">traj_ensemble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">traj_ensemble</span><span class="p">,(</span><span class="n">ntra</span><span class="p">,</span> <span class="n">ntime</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">traj_ensemble</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">starttime</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pyantarctica</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dataset.html">pyantarctica.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualizing.html">pyantarctica.visualizing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../baselines_scripts.html">pyantarctica.baselines_scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modeling.html">pyantarctica.modeling</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Swiss Data Science Center.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.8</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>